<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1.0,maximum-scale=1.0,user-scalable=no" />
<title>Velocidad desde Acelerómetro / Giroscopio — Mobile</title>
<style>
  :root{--bg:#0f1724;--card:#111827;--accent:#06b6d4;--muted:#94a3b8;--glass:rgba(255,255,255,0.04);}
  html,body{height:100%;margin:0;font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial;background:linear-gradient(180deg,#071023,#081226);color:#e6eef6;}
  .app{max-width:900px;margin:12px auto;padding:12px;box-sizing:border-box;}
  .header{display:flex;gap:8px;align-items:center;flex-wrap:wrap;}
  button{background:var(--accent);color:#052024;border:none;padding:8px 10px;border-radius:10px;font-weight:600;cursor:pointer;}
  .controls{display:grid;grid-template-columns:repeat(2,1fr);gap:8px;margin-top:10px;}
  .card{background:var(--card);padding:10px;border-radius:12px;box-shadow:0 6px 20px rgba(2,6,23,0.6);}
  label{display:block;font-size:.8rem;color:var(--muted);margin-bottom:6px;}
  input[type=range]{width:100%;}
  .small{font-size:.78rem;color:var(--muted);}
  .stat{background:var(--glass);padding:10px;border-radius:8px;min-width:110px;text-align:center;}
  .stat .num{font-weight:700;font-size:1rem;}
  canvas{width:100%;height:180px;background:rgba(255,255,255,0.02);border-radius:8px;display:block;}
  @media(max-width:520px){.controls{grid-template-columns:1fr;}}
</style>
</head>
<body>
<div class="app">

  <div class="header">
    <div style="font-weight:600">Velocidad desde sensores</div>
    <button id="permBtn">Permiso</button>
    <button id="resetBtn">Resetear</button>
    <button id="soundBtn">Sonido OFF</button>
  </div>

  <div class="controls">
    <div class="card">
      <label>Umbral quietud (m/s²)</label>
      <input id="threshold" type="range" min="0.01" max="1.5" step="0.01" value="0.12">
      <input id="thresholdNum" type="number" min="0.01" max="3" step="0.01" value="0.12">
    </div>

    <div class="card">
      <label>Tiempo quietud (ms)</label>
      <input id="holdTime" type="range" min="50" max="1000" step="10" value="200">
      <input id="holdTimeNum" type="number" min="50" max="2000" step="10" value="200">
    </div>
  </div>

  <div class="card">
    <label>Alpha filtro gravedad</label>
    <input id="alpha" type="range" min="0.5" max="0.98" step="0.01" value="0.92">
    <input id="alphaNum" type="number" min="0.5" max="0.99" step="0.01" value="0.92">
    <label><input id="autoZero" type="checkbox" checked> Auto-zero suave</label>
    <label><input id="showComponents" type="checkbox" checked> Mostrar XYZ</label>
    <button id="calibrateBtn">Calibrar</button>
  </div>

  <div class="card">
    <div class="stat"><div class="num" id="vMag">0.000 m/s</div>|v|</div>
    <div style="display:flex;gap:8px;margin-top:6px">
      <div class="stat" id="vxStat"><div class="num" id="vx">0.000</div>x</div>
      <div class="stat" id="vyStat"><div class="num" id="vy">0.000</div>y</div>
      <div class="stat" id="vzStat"><div class="num" id="vz">0.000</div>z</div>
    </div>
    <div style="margin-top:4px;font-size:.8rem">Rate: <span id="srate">—</span> Hz</div>
    <canvas id="chart"></canvas>
  </div>

</div>

<script>
let gravity={x:0,y:0,z:0},bias={x:0,y:0,z:0},v={x:0,y:0,z:0},lastTs=null,samples=[];
let stationarySince=null,srate=0,sampleCount=0,srateLastTime=performance.now();
const WINDOW_MS=3000,DECAY=0.92;

// sonido
let audioCtx=null,osc=null,gainNode=null,soundEnabled=false;

// UI refs
const th=threshold,thN=thresholdNum,ht=holdTime,htN=holdTimeNum,a=alpha,aN=alphaNum;
const vMagEl=vMag,vxEl=vx,vyEl=vy,vzEl=vz,lastAccEl=lastAcc,lastRotEl=lastRot,srateEl=srate;

threshold.oninput=()=>thN.value=th.value; thN.onchange=()=>th.value=thN.value;
holdTime.oninput=()=>htN.value=ht.value; htN.onchange=()=>ht.value=htN.value;
alpha.oninput=()=>aN.value=a.value; aN.onchange=()=>a.value=aN.value;

soundBtn.onclick=()=>{
  if(!soundEnabled){
    audioCtx=new (window.AudioContext||window.webkitAudioContext)();
    osc=audioCtx.createOscillator(); gainNode=audioCtx.createGain();
    osc.frequency.value=800; gainNode.gain.value=0;
    osc.connect(gainNode).connect(audioCtx.destination); osc.start();
    soundEnabled=true; soundBtn.textContent="Sonido ON";
  } else {
    osc.stop(); audioCtx.close(); soundEnabled=false; soundBtn.textContent="Sonido OFF";
  }
};

permBtn.onclick=async()=>{
  if(typeof DeviceMotionEvent!=='undefined'&&DeviceMotionEvent.requestPermission){
    let r=await DeviceMotionEvent.requestPermission(); alert(r);
  }};

resetBtn.onclick=()=>{v={x:0,y:0,z:0};samples=[];gravity={x:0,y:0,z:0};bias={x:0,y:0,z:0};};

calibrateBtn.onclick=()=>{
  if(samples.length<20){alert("Poner quieto y esperar...");return;}
  let sx=0,sy=0,sz=0,N=Math.min(100,samples.length);
  for(let i=samples.length-N;i<samples.length;i++){sx+=samples[i].ax;sy+=samples[i].ay;sz+=samples[i].az;}
  bias.x=sx/N; bias.y=sy/N; bias.z=sz/N; alert("Calibrado");
};

function checkStationary(now,m){
  let thr=parseFloat(th.value),hold=+ht.value;
  if(m<=thr){if(!stationarySince) stationarySince=now;
    if(now-stationarySince>=hold)return true;} else stationarySince=null;
  return false;
}

function updateUI(){
  const mag=Math.sqrt(v.x*v.x+v.y*v.y+v.z*v.z);
  vMagEl.textContent=mag.toFixed(3)+" m/s"; vxEl.textContent=v.x.toFixed(4);
  vyEl.textContent=v.y.toFixed(4); vzEl.textContent=v.z.toFixed(4);
  srateEl.textContent=srate?" "+srate:"—";
  vxStat.style.display=showComponents.checked?"block":"none";
  vyStat.style.display=showComponents.checked?"block":"none";
  vzStat.style.display=showComponents.checked?"block":"none";

  if(soundEnabled&&gainNode){
    const level=Math.min(1,mag*0.8);
    gainNode.gain.setTargetAtTime(level,audioCtx.currentTime,0.02);
  }
}

const canvas=chart,ctx=canvas.getContext("2d");
function resize(){const r=canvas.getBoundingClientRect(),dpr=window.devicePixelRatio||1;
  canvas.width=r.width*dpr;canvas.height=r.height*dpr;ctx.setTransform(dpr,0,0,dpr,0,0);} resize();
addEventListener("resize",resize);

addEventListener("devicemotion",e=>{
  const now=performance.now(); let ax,ay,az;
  if(e.acceleration&&e.acceleration.x!=null){ax=e.acceleration.x;ay=e.acceleration.y;az=e.acceleration.z;}
  else if(e.accelerationIncludingGravity){
    let inc=e.accelerationIncludingGravity,rot=e.rotationRate||{},rotMag=Math.abs(rot.alpha||0)+Math.abs(rot.beta||0)+Math.abs(rot.gamma||0);
    let base=+a.value,alphaDyn=Math.max(.5,Math.min(.99,base-(Math.min(1,rotMag/90))*0.25));
    gravity.x=alphaDyn*gravity.x+(1-alphaDyn)*(inc.x||0);
    gravity.y=alphaDyn*gravity.y+(1-alphaDyn)*(inc.y||0);
    gravity.z=alphaDyn*gravity.z+(1-alphaDyn)*(inc.z||0);
    ax=(inc.x||0)-gravity.x; ay=(inc.y||0)-gravity.y; az=(inc.z||0)-gravity.z;
  } else return;

  ax-=bias.x;ay-=bias.y;az-=bias.z;
  let dt=lastTs?(now-lastTs)/1000:0; lastTs=now;
  if(dt>0&&dt<.5){v.x+=ax*dt;v.y+=ay*dt;v.z+=az*dt;}

  const mag=Math.sqrt(v.x*v.x+v.y*v.y+v.z*v.z);
  samples.push({t:now,vx:v.x,vy:v.y,vz:v.z,mag,ax,ay,az});
  let cut=now-WINDOW_MS-200; while(samples.length&&samples[0].t<cut)samples.shift();

  sampleCount++; let t2=performance.now(); if(t2-srateLastTime>=1000){srate=Math.round(sampleCount*1000/(t2-srateLastTime));sampleCount=0;srateLastTime=t2;}

  if(checkStationary(now,Math.sqrt(ax*ax+ay*ay+az*az))&&autoZero.checked){
    v.x*=DECAY;v.y*=DECAY;v.z*=DECAY;
  }
  updateUI();
},{passive:true});

function draw(){
  resize();const r=canvas.getBoundingClientRect(),w=r.width,h=r.height,now=performance.now(),t0=now-WINDOW_MS;
  ctx.clearRect(0,0,w,h);
  ctx.beginPath();let first=1;
  for(const s of samples){
    const x=((s.t-t0)/WINDOW_MS)*w, y=h-(s.mag*20);
    if(first){ctx.moveTo(x,y);first=0;} else ctx.lineTo(x,y);
  }
  ctx.strokeStyle="#06b6d4";ctx.lineWidth=2;ctx.stroke();
  requestAnimationFrame(draw);
}
draw();
</script>
</body>
</html>
