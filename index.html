<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Velocímetro Sonoro</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Helvetica Neue', Arial, sans-serif;
        }

        body {
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            color: #e6e6e6;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            padding: 20px;
            overflow: hidden;
        }

        .header {
            text-align: center;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .header h1 {
            font-size: 1.8rem;
            font-weight: 300;
            letter-spacing: 1px;
        }

        .status-container {
            display: flex;
            justify-content: space-between;
            margin-bottom: 20px;
        }

        .status {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 10px;
            padding: 15px;
            width: 48%;
            text-align: center;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        .status-value {
            font-size: 1.8rem;
            font-weight: 300;
            margin-top: 5px;
            color: #4cc9f0;
        }

        .velocity-display {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        .velocity-title {
            text-align: center;
            margin-bottom: 15px;
            font-weight: 300;
            font-size: 1.2rem;
        }

        .velocity-components {
            display: flex;
            justify-content: space-between;
        }

        .velocity-component {
            text-align: center;
            width: 30%;
            min-width: 70px; /* Tamaño fijo para evitar cambios */
        }

        .component-label {
            font-size: 0.9rem;
            margin-bottom: 5px;
            color: #a5b1c2;
        }

        .component-value {
            font-size: 1.3rem;
            font-weight: 300;
            min-height: 1.5em; /* Altura fija para evitar cambios */
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .controls {
            display: flex;
            flex-direction: column;
            gap: 15px;
            margin-bottom: 20px;
        }

        .control-group {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 10px;
            padding: 15px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        .control-title {
            margin-bottom: 10px;
            font-weight: 300;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .control-value {
            font-size: 1.1rem;
            color: #4cc9f0;
        }

        .slider-container {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .slider {
            flex: 1;
            -webkit-appearance: none;
            height: 5px;
            border-radius: 5px;
            background: rgba(255, 255, 255, 0.1);
            outline: none;
        }

        .slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 18px;
            height: 18px;
            border-radius: 50%;
            background: #4cc9f0;
            cursor: pointer;
        }

        .action-buttons {
            display: flex;
            gap: 10px;
            margin-top: 10px;
        }

        .btn {
            flex: 1;
            padding: 12px;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: 300;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .btn-primary {
            background: #4cc9f0;
            color: #16213e;
        }

        .btn-secondary {
            background: rgba(255, 255, 255, 0.1);
            color: #e6e6e6;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
        }

        .btn:active {
            transform: translateY(0);
        }

        .footer {
            text-align: center;
            margin-top: auto;
            padding-top: 20px;
            font-size: 0.8rem;
            color: #a5b1c2;
        }

        .sound-indicator {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 8px;
            background-color: #e74c3c;
        }

        .sound-on {
            background-color: #2ecc71;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0% {
                transform: scale(0.95);
                box-shadow: 0 0 0 0 rgba(46, 204, 113, 0.7);
            }
            70% {
                transform: scale(1);
                box-shadow: 0 0 0 10px rgba(46, 204, 113, 0);
            }
            100% {
                transform: scale(0.95);
                box-shadow: 0 0 0 0 rgba(46, 204, 113, 0);
            }
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>Velocímetro Sonoro</h1>
    </div>

    <div class="status-container">
        <div class="status">
            <div>Velocidad Total</div>
            <div class="status-value" id="total-velocity">0.00 m/s</div>
        </div>
        <div class="status">
            <div>Estado</div>
            <div class="status-value" id="motion-status">En Movimiento</div>
        </div>
    </div>

    <div class="velocity-display">
        <div class="velocity-title">Componentes de Velocidad</div>
        <div class="velocity-components">
            <div class="velocity-component">
                <div class="component-label">X</div>
                <div class="component-value" id="velocity-x">0.00</div>
            </div>
            <div class="velocity-component">
                <div class="component-label">Y</div>
                <div class="component-value" id="velocity-y">0.00</div>
            </div>
            <div class="velocity-component">
                <div class="component-label">Z</div>
                <div class="component-value" id="velocity-z">0.00</div>
            </div>
        </div>
    </div>

    <div class="controls">
        <div class="control-group">
            <div class="control-title">
                <span>Umbral de Quietud</span>
                <span class="control-value" id="still-threshold-value">0.5 m/s²</span>
            </div>
            <div class="slider-container">
                <input type="range" min="0.1" max="2" step="0.1" value="0.5" class="slider" id="still-threshold">
            </div>
        </div>

        <div class="control-group">
            <div class="control-title">
                <span>Tiempo de Quietud</span>
                <span class="control-value" id="still-time-value">500 ms</span>
            </div>
            <div class="slider-container">
                <input type="range" min="100" max="2000" step="100" value="500" class="slider" id="still-time">
            </div>
        </div>

        <div class="control-group">
            <div class="control-title">
                <span>Umbral de Sonido</span>
                <span class="control-value" id="sound-threshold-value">2.0 m/s</span>
            </div>
            <div class="slider-container">
                <input type="range" min="0.5" max="10" step="0.5" value="2.0" class="slider" id="sound-threshold">
            </div>
        </div>

        <div class="control-group">
            <div class="control-title">
                <span>Decaimiento del Sonido</span>
                <span class="control-value" id="sound-decay-value">3.0</span>
            </div>
            <div class="slider-container">
                <input type="range" min="0.5" max="10" step="0.5" value="3.0" class="slider" id="sound-decay">
            </div>
            <div style="font-size: 0.8rem; color: #a5b1c2; margin-top: 5px;">
                (Valores más altos = decaimiento más rápido)
            </div>
        </div>

        <div class="action-buttons">
            <button class="btn btn-primary" id="toggle-sound">
                <span class="sound-indicator" id="sound-indicator"></span>
                Sonido: ON
            </button>
            <button class="btn btn-secondary" id="reset-velocity">Reiniciar Velocidad</button>
        </div>
    </div>

    <div class="footer">
        Mueve tu dispositivo para activar el sonido
    </div>

    <script>
        // Variables de estado
        let velocity = { x: 0, y: 0, z: 0 };
        let lastAcceleration = { x: 0, y: 0, z: 0 };
        let lastTimestamp = 0;
        let stillTimeCounter = 0;
        let soundEnabled = true;
        let audioContext;
        let guitarBuffer;
        let isPlaying = false;

        // Configuración inicial
        let stillThreshold = 0.5; // m/s²
        let stillTimeThreshold = 500; // ms
        let soundThreshold = 2.0; // m/s
        let soundDecay = 3.0; // Factor de decaimiento del sonido

        // Elementos de la UI
        const totalVelocityElement = document.getElementById('total-velocity');
        const motionStatusElement = document.getElementById('motion-status');
        const velocityXElement = document.getElementById('velocity-x');
        const velocityYElement = document.getElementById('velocity-y');
        const velocityZElement = document.getElementById('velocity-z');
        const stillThresholdElement = document.getElementById('still-threshold');
        const stillThresholdValueElement = document.getElementById('still-threshold-value');
        const stillTimeElement = document.getElementById('still-time');
        const stillTimeValueElement = document.getElementById('still-time-value');
        const soundThresholdElement = document.getElementById('sound-threshold');
        const soundThresholdValueElement = document.getElementById('sound-threshold-value');
        const soundDecayElement = document.getElementById('sound-decay');
        const soundDecayValueElement = document.getElementById('sound-decay-value');
        const toggleSoundButton = document.getElementById('toggle-sound');
        const resetVelocityButton = document.getElementById('reset-velocity');
        const soundIndicator = document.getElementById('sound-indicator');

        // Inicializar audio
        function initAudio() {
            audioContext = new (window.AudioContext || window.webkitAudioContext)();
            
            // Crear un sonido de guitarra acústica A7 sintetizado
            createGuitarSound();
        }

        // Crear un sonido de guitarra acústica A7 sintetizado
        function createGuitarSound() {
            const duration = 1.5;
            const sampleRate = audioContext.sampleRate;
            const frameCount = sampleRate * duration;
            
            const buffer = audioContext.createBuffer(2, frameCount, sampleRate);
            const leftChannel = buffer.getChannelData(0);
            const rightChannel = buffer.getChannelData(1);
            
            // Frecuencias para el acorde A7 (A, C#, E, G)
            const frequencies = [220.0, 277.18, 329.63, 392.0];
            
            for (let i = 0; i < frameCount; i++) {
                const time = i / sampleRate;
                
                // Generar cada frecuencia del acorde
                let sample = 0;
                for (let freq of frequencies) {
                    // Oscilador principal con forma de onda más compleja
                    let oscillator = Math.sin(2 * Math.PI * freq * time);
                    
                    // Agregar armónicos para simular una guitarra
                    oscillator += 0.3 * Math.sin(2 * Math.PI * 2 * freq * time);
                    oscillator += 0.1 * Math.sin(2 * Math.PI * 3 * freq * time);
                    oscillator += 0.05 * Math.sin(2 * Math.PI * 4 * freq * time);
                    
                    // Envolvente de ataque y decaimiento con factor ajustable
                    const envelope = Math.exp(-time * soundDecay) * (1 - Math.exp(-time * 20));
                    
                    sample += oscillator * envelope;
                }
                
                // Normalizar y aplicar ruido de cuerda
                sample = sample / frequencies.length;
                
                // Agregar un poco de ruido para simular el sonido de cuerda
                if (time < 0.05) {
                    sample += (Math.random() - 0.5) * 0.1 * (1 - time / 0.05);
                }
                
                // Aplicar a ambos canales con ligera diferencia para efecto estéreo
                leftChannel[i] = sample * 0.6;
                rightChannel[i] = sample * 0.4;
            }
            
            guitarBuffer = buffer;
        }

        // Reproducir sonido de guitarra
        function playSound() {
            if (!soundEnabled || !audioContext || isPlaying) return;
            
            isPlaying = true;
            
            // Recrear el buffer con el factor de decaimiento actual
            createGuitarSound();
            
            const source = audioContext.createBufferSource();
            source.buffer = guitarBuffer;
            
            // Crear un filtro para simular la resonancia de una guitarra acústica
            const filter = audioContext.createBiquadFilter();
            filter.type = 'lowpass';
            filter.frequency.value = 2000;
            
            // Conectar y reproducir
            source.connect(filter);
            filter.connect(audioContext.destination);
            
            source.start();
            
            // Permitir reproducir de nuevo después de un tiempo
            setTimeout(() => {
                isPlaying = false;
            }, 500);
        }

        // Actualizar la UI con los valores actuales
        function updateUI() {
            const totalVelocity = Math.sqrt(
                velocity.x * velocity.x + 
                velocity.y * velocity.y + 
                velocity.z * velocity.z
            );
            
            totalVelocityElement.textContent = totalVelocity.toFixed(2) + ' m/s';
            velocityXElement.textContent = velocity.x.toFixed(2);
            velocityYElement.textContent = velocity.y.toFixed(2);
            velocityZElement.textContent = velocity.z.toFixed(2);
            
            // Cambiar color según la velocidad
            if (totalVelocity > soundThreshold) {
                totalVelocityElement.style.color = '#e74c3c';
            } else {
                totalVelocityElement.style.color = '#4cc9f0';
            }
        }

        // Procesar datos del acelerómetro
        function handleMotionEvent(event) {
            const acceleration = event.accelerationIncludingGravity;
            const timestamp = event.timeStamp || Date.now();
            
            // Calcular delta de tiempo en segundos
            const dt = (timestamp - lastTimestamp) / 1000;
            lastTimestamp = timestamp;
            
            // Si es la primera lectura, inicializar y salir
            if (lastAcceleration.x === 0 && lastAcceleration.y === 0 && lastAcceleration.z === 0) {
                lastAcceleration = { 
                    x: acceleration.x, 
                    y: acceleration.y, 
                    z: acceleration.z 
                };
                return;
            }
            
            // Integrar aceleración para obtener velocidad (método trapezoidal para mejor precisión)
            if (dt > 0 && dt < 0.1) { // Evitar valores extremos de dt
                velocity.x += (lastAcceleration.x + acceleration.x) / 2 * dt;
                velocity.y += (lastAcceleration.y + acceleration.y) / 2 * dt;
                velocity.z += (lastAcceleration.z + acceleration.z) / 2 * dt;
            }
            
            // Actualizar última aceleración
            lastAcceleration = { 
                x: acceleration.x, 
                y: acceleration.y, 
                z: acceleration.z 
            };
            
            // Detectar si estamos en estado de quietud
            const accelerationMagnitude = Math.sqrt(
                acceleration.x * acceleration.x + 
                acceleration.y * acceleration.y + 
                acceleration.z * acceleration.z
            );
            
            // Considerar la gravedad (aproximadamente 9.8 m/s²)
            const movementAcceleration = Math.abs(accelerationMagnitude - 9.8);
            
            if (movementAcceleration < stillThreshold) {
                stillTimeCounter += dt * 1000; // Convertir a ms
                
                if (stillTimeCounter >= stillTimeThreshold) {
                    // Llevar velocidad a cero con suavizado
                    velocity.x *= 0.9;
                    velocity.y *= 0.9;
                    velocity.z *= 0.9;
                    
                    // Si la velocidad es muy pequeña, establecer a cero
                    if (Math.abs(velocity.x) < 0.01) velocity.x = 0;
                    if (Math.abs(velocity.y) < 0.01) velocity.y = 0;
                    if (Math.abs(velocity.z) < 0.01) velocity.z = 0;
                    
                    motionStatusElement.textContent = 'En Reposo';
                    motionStatusElement.style.color = '#2ecc71';
                }
            } else {
                stillTimeCounter = 0;
                motionStatusElement.textContent = 'En Movimiento';
                motionStatusElement.style.color = '#e74c3c';
            }
            
            // Reproducir sonido si se supera el umbral
            const currentVelocity = Math.sqrt(
                velocity.x * velocity.x + 
                velocity.y * velocity.y + 
                velocity.z * velocity.z
            );
            
            if (currentVelocity > soundThreshold && soundEnabled) {
                playSound();
            }
            
            updateUI();
        }

        // Configurar event listeners
        function setupEventListeners() {
            // Solicitar permiso para el sensor de movimiento
            if (typeof DeviceMotionEvent.requestPermission === 'function') {
                DeviceMotionEvent.requestPermission()
                    .then(permissionState => {
                        if (permissionState === 'granted') {
                            window.addEventListener('devicemotion', handleMotionEvent);
                        }
                    })
                    .catch(console.error);
            } else {
                window.addEventListener('devicemotion', handleMotionEvent);
            }
            
            // Controladores para los sliders
            stillThresholdElement.addEventListener('input', function() {
                stillThreshold = parseFloat(this.value);
                stillThresholdValueElement.textContent = stillThreshold.toFixed(1) + ' m/s²';
            });
            
            stillTimeElement.addEventListener('input', function() {
                stillTimeThreshold = parseInt(this.value);
                stillTimeValueElement.textContent = stillTimeThreshold + ' ms';
            });
            
            soundThresholdElement.addEventListener('input', function() {
                soundThreshold = parseFloat(this.value);
                soundThresholdValueElement.textContent = soundThreshold.toFixed(1) + ' m/s';
            });
            
            soundDecayElement.addEventListener('input', function() {
                soundDecay = parseFloat(this.value);
                soundDecayValueElement.textContent = soundDecay.toFixed(1);
                // Recrear el buffer con el nuevo factor de decaimiento
                if (audioContext) {
                    createGuitarSound();
                }
            });
            
            // Botón para activar/desactivar sonido
            toggleSoundButton.addEventListener('click', function() {
                soundEnabled = !soundEnabled;
                if (soundEnabled) {
                    this.innerHTML = '<span class="sound-indicator sound-on"></span> Sonido: ON';
                    soundIndicator.classList.add('sound-on');
                } else {
                    this.innerHTML = '<span class="sound-indicator"></span> Sonido: OFF';
                    soundIndicator.classList.remove('sound-on');
                }
            });
            
            // Botón para reiniciar velocidad
            resetVelocityButton.addEventListener('click', function() {
                velocity = { x: 0, y: 0, z: 0 };
                lastAcceleration = { x: 0, y: 0, z: 0 };
                stillTimeCounter = 0;
                updateUI();
            });
        }

        // Inicializar la aplicación
        function initApp() {
            initAudio();
            setupEventListeners();
            updateUI();
            
            // Inicializar el último timestamp
            lastTimestamp = performance.now();
        }

        // Iniciar cuando el DOM esté listo
        document.addEventListener('DOMContentLoaded', initApp);
    </script>
</body>
</html>
